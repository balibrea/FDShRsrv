<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: "Lato", sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100vh;
            margin: 0;
        }

        /* Sidebar Styles */
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidebar a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidebar a:hover {
            color: #f1f1f1;
        }

        .sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        .openbtn {
            font-size: 20px;
            cursor: pointer;
            background-color: #111;
            color: white;
            padding: 10px 15px;
            border: none;
        }

        .openbtn:hover {
            background-color: #444;
        }

        #main {
            padding: 16px;
            margin-bottom: 150px;
            /* Match the height of the #info-frame */
            transition: margin-left .5s;

            display: flex;
            flex-direction: column;
            /* Stack items vertically */
            height: 100%;
            /* Full height of the viewport */
        }

        .body {
            flex: 1;
            /* Take remaining space between menu and status bar */
            /*background-color: #f1f1f1;  Light grey background for body */
            padding: 20px;
            /* Padding for body content */
            display: flex;
            /* Optional: use flex for inner content */
            justify-content: center;
            /* Center content horizontally */
            align-items: center;
            /* Center content vertically */
            flex-direction: column;
            /* Stack items vertically */
        }

        table,
        th,
        td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        .green {
            background-color: green;
            color: rgb(7, 7, 7);
        }

        .red {
            background-color: red;
            color: black;
        }

        .yellow {
            background-color: yellow;
            color: black;
        }

        table {
            margin: 0 auto;
            width: auto;
        }

        th {
            background-color: lightblue;
        }

        td {
            color: black;
            max-width: 80px;
            /* Establece un ancho máximo */
            white-space: pre-wrap;
            /* Permite texto multilinea */
            word-wrap: break-word;
            /* Permite el ajuste de palabras largas */
            overflow: hidden;
            /* Oculta el desbordamiento */
            padding: 2px;
            /* Espaciado interno */
            text-overflow: ellipsis;
            /* Agrega puntos suspensivos si el texto es demasiado largo */
        }

        td:hover {
            background-color: lightyellow;
        }

        @media screen and (max-height: 450px) {
            .sidebar {
                padding-top: 15px;
            }

            .sidebar a {
                font-size: 18px;
            }
        }

        /* Split the screen in half vertically */
        .split {
            height: 50%;
            /* Each section takes half the height */
            width: 25%;
            /* Full width */
            position: fixed;
            z-index: 1;
            top: 0;
            overflow-x: hidden;
            padding-top: 20px;
        }

        /* Control the top side */
        .top {
            top: 0;
            /* Aligns to the top */
            background-color: #252424;
            /* Dark background for the top section */
        }

        /* Control the bottom side */
        .bottom {
            bottom: 0;
            /* Aligns to the bottom */
            background-color: rgb(233, 116, 7);
            /* Red background for the bottom section */
        }

        /* If you want the content centered horizontally and vertically */
        .centered {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        /* Style table for bottom side */
        #fileTable {
            width: 100%;
            border-collapse: collapse;
        }

        #fileTable td {
            white-space: nowrap;
            /* Prevents word wrapping */
            overflow: hidden;
            /* Hides overflow text */
            text-overflow: ellipsis;
            /* Shows ellipsis for overflowed text */
            padding: 5px;
            /* Adds some padding */
            border: 1px solid #fff;
            /* Border color for cells */
        }

        .context-menu {
            position: absolute;
            display: none;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .context-menu button {
            display: block;
            width: 100%;
            padding: 8px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
        }

        .context-menu button:hover {
            background-color: #f0f0f0;
        }

        /* Menu Bar */
        .menu {
            background-color: #f7f1e5;
            padding: 10px;
            display: flex;
            /* Use flexbox for alignment */
            justify-content: space-between;
            /* Space between left and right contents */
            align-items: center;
            /* Center the contents vertically */
        }

        .menu select,
        .menu button {
            padding: 5px;
            /* Reduced padding for thinner appearance */
            margin: 0 5px;
            /* Margin remains the same */
            font-size: 14px;
            /* Reduced font size */
        }

        .menu button {
            background-color: #3b3f3b;
            /* Button color */
            color: white;
            /* Button text color */
            border: none;
            /* No border */
            cursor: pointer;
            /* Pointer cursor */
        }

        .menu button:hover {
            background-color: #45a049;
            /* Button hover color */
        }

        #info-frame {
            position: relative;
            /* Relative to the #content container */
            bottom: 0;
            /* Align at the bottom of #content */
            width: 100%;
            background-color: #f9f9f9;
            border-top: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            box-sizing: border-box;
            display: none;
            /* Initially hidden */
        }

        #file-table {
            width: 100%;
            border-collapse: collapse;
        }

        #file-table th,
        #file-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        #file-table th {
            background-color: #f4f4f4;
        }
    </style>
</head>

<body>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>

        <!-- Top Section for Current Information -->
        <div style="padding: 10px; background-color: #222; color: #fff;">
            <h3 style="color: #818181; padding-left: 32px;">Shift Day</h3>
            <label>
                <input type="checkbox" id="show-info-checkbox">
                Show Info Frame
            </label><br><br>
            <label for="rowSelect" style="color: #818181; padding-left: 32px;">FD Building:</label>
            <select id="rowSelect" style="margin-left: 32px;"></select><br><br>

            <label for="colSelect" style="color: #818181; padding-left: 32px;">Shift Day:</label>
            <select id="colSelect" style="margin-left: 32px;"></select><br><br>

            <label for="cellText" style="color: #818181; padding-left: 32px;">Text:</label>
            <input type="text" id="cellText"><br><br>

            <label for="cellColor" style="color: #818181; padding-left: 32px;">Background Color:</label>
            <select id="cellColor" style="margin-left: 32px;">
                <option value="">Select color</option>
                <option value="red">Red</option>
                <option value="yellow">Yellow</option>
                <option value="green">Green</option>
            </select><br><br>

            <button onclick="editCell()" style="margin-left: 32px;">Edit Cell</button>
        </div>


        <!-- Bottom Section for Created Files -->
        <div style="padding: 10px; background-color: #e7a20e; color: #050505; margin-top: 10px;">
            <h4 style="text-align: center;">Created Files</h4>
            <table id="fileTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #fff; padding: 5px;">File Name</th>
                        <th style="border: 1px solid #fff; padding: 5px;">Creation Time</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic content will be populated here -->
                    <tr>
                        <td style="border: 1px solid #fff; padding: 5px;">example_file1.txt</td>
                        <td style="border: 1px solid #fff; padding: 5px;">2023-10-01 12:00</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #fff; padding: 5px;">example_file2.txt</td>
                        <td style="border: 1px solid #fff; padding: 5px;">2023-10-02 15:30</td>
                    </tr>
                    <!-- Additional rows can be added here dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="main">

        <!-- Menu Bar -->
        <div class="menu">
            <button class="openbtn" onclick="toggleNav()">☰ Open/Close Sidebar</button>

            <h2 style="text-align: center; margin: auto;">FD Shifts Status</h2>

            <div class="menu-right">
                <label for="dateSelect">Select Date:</label>
                <select id="dateSelect">
            
                    {% for shift in shifts %}
                    <option value="{{ shift }}">{{ shift }}</option>
                    {% endfor %}
            
                </select>
                <button onclick="saveDate()">Save</button>
            </div>
        </div>

        <div class="body">

            {% for t in range(table_cnt) %}
            <p style="text-align: center;">Shift period from {{ dates[t] }}</p>

            <table id="shiftTable{{t+1}}" onclick="handleTableClick(event)">
                <colgroup>
                    <col span="2" style="background-color: lightblue">
                    <col span="3" style="background-color: green">
                </colgroup>

                <thead>
                    <tr>
                        <th> </th>
                        {% if t < (table_cnt -1) %} {% for col in days[t * MAX_COL : (t + 1) * MAX_COL] %} <th>{{ col }}
                            </th>
                            {% endfor %}

                            {% else %}
                            {% for col in days[t * MAX_COL : ] %}
                            <th>{{ col }}</th>
                            {% endfor %}

                            {% endif %}
                    </tr>
                </thead>

                <tbody>
                    {% for shift, statuses in data.items() %}
                    <tr>
                        <td>{{ shift }}</td>
                        {% if t < 1 %} {% for status in statuses[:MAX_COL] %} <td class="{{ status[1] }}">{{ status[0]
                            }}</td>
                            {% endfor %}
                            {% else %}
                            {% for status in statuses[MAX_COL:] %}
                            <td class="{{ status[1] }}">{{ status[0] }}</td>
                            {% endfor %}
                            {% endif%}
                    </tr>
                    {% endfor %}
                </tbody>

            </table>

            {% endfor %}

        </div>


        <div id="info-frame">
            <h3>Files Associated with Selected Cell</h3>
            <table id="file-table">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Last Modified</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3" style="text-align: center;">Click on a cell to view associated files.</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <div id="context-menu" class="context-menu">
        <button onclick="changeColor('red')">Red</button>
        <button onclick="changeColor('green')">Green</button>
        <button onclick="changeColor('yellow')">Yellow</button>
    </div>

    <script>
        let isOpen = false; // Track the sidebar state
        let tableSelect = "1";
        const tables = ["shiftTable1", "shiftTable2"];
        const contextMenu = document.getElementById("context-menu");
        const infoFrame = document.getElementById("info-frame");
        const fileTableBody = document.querySelector("#file-table tbody");
        const showInfoCheckbox = document.getElementById('show-info-checkbox');
        let currentCell;

        function toggleNav() {
            if (isOpen) {
                closeNav();
            } else {
                openNav();
            }
        }

        function openNav() {
            document.getElementById("mySidebar").style.width = "350px";
            document.getElementById("main").style.marginLeft = "350px";
            isOpen = true; // Update the state
            populateRowAndColumnSelects(); // Populate the selects when opening
        }

        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
            isOpen = false; // Update the state
        }

        function populateRowAndColumnSelects() {
            //const tableSelect = document.getElementById('tableSelect').value;
            const rowSelect = document.getElementById('rowSelect');
            const colSelect = document.getElementById('colSelect');

            // Clear previous options
            rowSelect.innerHTML = "";
            colSelect.innerHTML = "";

            let rowNames = [];
            let colNames = [];

            if (tableSelect === "1") {
                rowNames = ["LL", "LM", "LA", "CO", "HE"];
                colNames = JSON.parse('{{ days|tojson|safe }}'); //["10-1", "11-1", "12-1", "13-1", "14-1", "15-1", "16-1", "17-1", "18-1"];
                console.log(colNames);
            } else if (tableSelect === "2") {
                rowNames = ["LL", "LM", "LA", "CO", "HE"];
                colNames = JSON.parse('{{ days|tojson|safe }}');//["19-1", "20-1", "21-1", "22-1", "23-1", "24-1", "25-1", "26-1", "27-1"];
            }

            // Populate row select
            rowNames.forEach(rowName => {
                const option = document.createElement('option');
                option.value = rowName;
                option.text = rowName;
                rowSelect.appendChild(option);
            });

            // Populate column select
            colNames.forEach(colName => {
                const option = document.createElement('option');
                option.value = colName;
                option.text = colName;
                colSelect.appendChild(option);
            });
        }

        function handleTableClick(event) {
            const cell = event.target;
            if (cell.tagName === 'TD') {
                const table = cell.closest('table');
                const tableId = table.id;
                tableSelect = tableId === 'shiftTable1' ? '1' : '2';

                const rowName = table.rows[cell.parentNode.rowIndex].cells[0].innerText;
                const colName = table.rows[0].cells[cell.cellIndex].innerText;

                // Set the selected table
                //document.getElementById('tableSelect').value = tableSelect;
                populateRowAndColumnSelects();

                // Set the selected row and column
                document.getElementById('rowSelect').value = rowName;
                document.getElementById('colSelect').value = colName;
            }
        }

        function editCell() {
            //const tableSelect = document.getElementById('tableSelect').value;
            const rowName = document.getElementById('rowSelect').value;
            const colName = document.getElementById('colSelect').value;
            const text = document.getElementById('cellText').value;
            const color = document.getElementById('cellColor').value;

            // Determine which table the selected column belongs to
            const table1Columns = Array.from(document.getElementById('shiftTable1').rows[0].cells).map(cell => cell.innerText);

            //const table2Columns = Array.from(document.getElementById('shiftTable2').rows[0].cells).map(cell => cell.innerText);

            let table = document.getElementById('shiftTable1');
            if (table1Columns.includes(colName)) {
                tableSelect = '1';
                table = document.getElementById('shiftTable1');
            } else {
                tableSelect = '2';
                table = document.getElementById('shiftTable2');
            }

            // Get row index from row name
            const rowIndex = Array.from(table.rows).findIndex(row => row.cells[0].innerText === rowName);
            // Get column index from column name
            const colIndex = Array.from(table.rows[0].cells).findIndex(cell => cell.innerText === colName);

            // Check if the row and column are valid
            if (rowIndex > 0 && colIndex > 0) {
                const cell = table.rows[rowIndex].cells[colIndex];
                if (text) cell.innerText = text; // Update cell text
                if (color) cell.style.backgroundColor = color; // Update cell background color

                // Change text color to black if background is red or yellow
                if (color === 'red' || color === 'yellow') {
                    cell.style.color = 'black'; // Set text color to black
                } else {
                    // Optionally reset to default or another color if other backgrounds are used
                    cell.style.color = ''; // Reset to default
                }
            }
        }

        function populateFileTable(files) {
            const fileTableBody = document.getElementById('fileTable').getElementsByTagName('tbody')[0];
            fileTableBody.innerHTML = ""; // Clear existing rows

            files.forEach(file => {
                const row = fileTableBody.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                cell1.innerText = file.name;
                cell2.innerText = file.creationTime;
                cell1.style.border = '1px solid #fff'; // Styling
                cell2.style.border = '1px solid #fff'; // Styling
            });
        }

        // Sample usage
        const filesData = [
            { name: "run_e4_010107_2024-11-29.04-50.root", creationTime: "2023-10-01 12:00" },
            { name: "run_e4_010105_2024-11-29.01-16.root", creationTime: "2023-10-02 14:30" }
        ];
        populateFileTable(filesData);

        tables.forEach((tableId) => {
            const table = document.getElementById(tableId);

            // Make cells editable on double-click
            table.addEventListener("dblclick", (e) => {
                if (e.target.tagName === "TD") {
                    e.target.contentEditable = true;
                    e.target.focus();

                    // Add blur event to make cell non-editable
                    e.target.addEventListener("blur", () => {
                        e.target.contentEditable = false; // Make the cell non-editable
                    });

                    // Optional: Allow to save changes with Enter key
                    e.target.addEventListener("keypress", (event) => {
                        if (event.key === "Enter") {
                            e.target.blur(); // Trigger the blur event on Enter key
                        }
                    });
                }
            });

            // Show context menu on right-click
            table.addEventListener("contextmenu", (e) => {
                e.preventDefault();
                if (e.target.tagName === "TD") {
                    currentCell = e.target;
                    contextMenu.style.top = `${e.pageY}px`;
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.display = "block";
                }
            });

            // Update file table on cell click and show the frame
            table.addEventListener("click", (e) => {
                if (showInfoCheckbox.checked && e.target.tagName === "TD") {
                    const cellRow = e.target.parentElement.rowIndex;
                    const cellCol = e.target.cellIndex;

                    const key = `${cellRow}-${cellCol}`;
                    const files = filesData[key] || [];

                    // Clear previous file data
                    fileTableBody.innerHTML = "";

                    if (files.length === 0) {
                        fileTableBody.innerHTML = `
                                <tr>
                                    <td colspan="3" style="text-align: center;">No files associated with this cell.</td>
                                </tr>`;
                    } else {
                        files.forEach((file) => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                    <td>${file.name}</td>
                                    <td>${file.size}</td>
                                    <td>${file.modified}</td>`;
                            fileTableBody.appendChild(row);
                        });
                    }

                    // Show the info frame
                    infoFrame.style.display = "block";
                }
            });
        });

        // Hide info frame when clicking outside of both tables or the context menu
        document.addEventListener("click", (e) => {
            const isClickInsideTable = tables.some((tableId) => {
                const table = document.getElementById(tableId);
                return table.contains(e.target);
            });

            if (!isClickInsideTable && !contextMenu.contains(e.target)) {
                infoFrame.style.display = "none";
            }
        });

        // Hide context menu on click elsewhere
        document.addEventListener("click", () => {
            contextMenu.style.display = "none";
        });

        // Change background color by updating the class
function changeColor(color) {
    if (currentCell) {
        // Remove existing color-related classes
        currentCell.classList.remove("red", "yellow", "green");

        // Add the new color class
        currentCell.classList.add(color);

        // Adjust text color based on the background class
        if (color === "red" || color === "yellow") {
            currentCell.style.color = "black"; // Set text color to black for better visibility
        } else {
            currentCell.style.color = ""; // Reset to default
        }
    }

    // Hide the context menu
    contextMenu.style.display = "none";
}


        // Add an event listener for when the select value changes
        document.getElementById('dateSelect').addEventListener('change', function() {
            const selectedShift = this.selectedIndex;

            // Send the selected value to the server via AJAX
            fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ selected_shift: selectedShift })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Response from server:", data);
                if (data.status === 'success') {
                    // Reload the page after successfully processing the POST request
                    window.location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        });

        // Define the pre-selected shift (this will be passed from Flask as a template variable)
        const selectedShift = "{{ selected_shift }}";

        // Set the value of the select element
        const dateSelect = document.getElementById("dateSelect");
        dateSelect.selectedIndex = selectedShift;

        function saveDate() {
            const tables = document.querySelectorAll('[id^="shiftTable"]'); // Select all tables with IDs starting with 'shiftTable'
            const tableData = [];

            // Loop through each table and extract data
            tables.forEach((table, tableIndex) => {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const shift = row.querySelector('td:first-child').innerText; // First column is the shift name
                    const statuses = Array.from(row.querySelectorAll('td:not(:first-child)')).map(cell => ({
                        text: cell.innerText,
                        color: cell.className, // Assuming class names represent the color
                    }));

                    tableData.push({
                        shift,
                        statuses,
                        tableIndex,
                    });
                });
            });

            console.log("Collected Table Data:", tableData);

            // Send the collected data to the server via AJAX
            fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tableData }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Data saved successfully!');
                    } else {
                        alert('Failed to save data!');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

    </script>

</body>

</html>
